"use strict";var startx,starty,endx,endy,board=[],score=0,best=0;function newGame(){for(var e=score=0;e<4;e++){board[e]=[];for(var r=0;r<4;r++)board[e][r]=0}updateBoardView(),ranNumber(),ranNumber()}function ranNumber(){for(;!noSpace();){var e=parseInt(Math.floor(4*Math.random())),r=parseInt(Math.floor(4*Math.random()));if(0==board[e][r])break}var o=Math.random()<.8?2:4;board[e][r]=o,showNumber(e,r,o)}function noSpace(){for(var e=0;e<4;e++)for(var r=0;r<4;r++)if(0==board[e][r])return!1;return!0}function updateBoardView(){$(".number-cell").remove();for(var e=0;e<4;e++)for(var r=0;r<4;r++){$(".grid-container").append('<div class="number-cell" id="number-cell-'+e+"-"+r+'"></div>');var o=$("#number-cell-"+e+"-"+r);0==board[e][r]?(o.css("width","0px"),o.css("height","0px"),o.css("top",getPosTop(e)+53),o.css("left",getPosLeft(r)+53)):(o.css("width",cellSize),o.css("height",cellSize),o.css("top",getPosTop(e)),o.css("left",getPosLeft(r)),o.css("background-color",getCellColor(board[e][r])),o.css("color",getNumColor(board[e][r])),o.text(board[e][r]))}}function canMoveLeft(){for(var e=0;e<4;e++)for(var r=1;r<4;r++)if(0!=board[e][r]&&(0==board[e][r-1]||board[e][r-1]==board[e][r]))return!0;return!1}function canMoveRight(){for(var e=0;e<4;e++)for(var r=0;r<3;r++)if(0!=board[e][r]&&(0==board[e][r+1]||board[e][r+1]==board[e][r]))return!0;return!1}function canMoveUp(){for(var e=1;e<4;e++)for(var r=0;r<4;r++)if(0!=board[e][r]&&(0==board[e-1][r]||board[e-1][r]==board[e][r]))return!0;return!1}function canMoveDown(){for(var e=0;e<3;e++)for(var r=0;r<4;r++)if(0!=board[e][r]&&(0==board[e+1][r]||board[e+1][r]==board[e][r]))return!0;return!1}function moveLeft(){if(canMoveLeft()){for(var e=0;e<4;e++)for(var r=[!1,!1,!1,!1],o=1;o<4;o++)if(0!=board[e][o]){for(var a=board[e][o],t=o,n=o-1;0<=n;n--)if(0!=board[e][n]){if(board[e][n]!=a||r[n])break;board[e][n]=2*a,score+=2*a,board[e][t]=0,r[t=n]=!0}else board[e][n]=a,board[e][t]=0,t=n;moveAnimation(e,o,e,n+1,r[n+1])}setTimeout("updateBoardView()",200),setTimeout("ranNumber()",200)}}function moveRight(){if(canMoveRight()){for(var e=0;e<4;e++)for(var r=[!1,!1,!1,!1],o=2;0<=o;o--)if(0!=board[e][o]){for(var a=board[e][o],t=o,n=o+1;n<4;n++)if(0!=board[e][n]){if(board[e][n]!=a||r[n])break;board[e][n]=2*board[e][n],score+=2*a,board[e][t]=0,r[t=n]=!0}else board[e][n]=a,board[e][t]=0,t=n;moveAnimation(e,o,e,n-1,r[n-1])}setTimeout("updateBoardView()",200),setTimeout("ranNumber()",200)}}function moveUp(){if(canMoveUp()){for(var e=0;e<4;e++)for(var r=[!1,!1,!1,!1],o=1;o<4;o++)if(0!=board[o][e]){for(var a=board[o][e],t=o,n=o-1;0<=n;n--)if(0!=board[n][e]){if(board[n][e]!=a||r[n])break;board[n][e]=2*board[n][e],score+=2*a,board[t][e]=0,r[t=n]=!0}else board[n][e]=a,board[t][e]=0,t=n;moveAnimation(o,e,n+1,e,r[n+1])}setTimeout("updateBoardView()",200),setTimeout("ranNumber()",200)}}function moveDown(){if(canMoveDown()){for(var e=0;e<4;e++)for(var r=[!1,!1,!1,!1],o=2;0<=o;o--)if(0!=board[o][e]){for(var a=board[o][e],t=o,n=o+1;n<4;n++)if(0!=board[n][e]){if(board[n][e]!=a||r[n])break;board[n][e]=2*board[n][e],score+=2*a,board[t][e]=0,r[t=n]=!0}else board[n][e]=a,board[t][e]=0,t=n;moveAnimation(o,e,n-1,e,r[n-1])}setTimeout("updateBoardView()",200),setTimeout("ranNumber()",200)}}window.onbeforeunload=function(){console.log("load"),best<score&&(best=score),localStorage.setItem("2048data",JSON.stringify({board:board,score:score,best:best}))},$(function(){var e=JSON.parse(localStorage.getItem("2048data"));null!=e?(board=e.board,score=e.score,best=e.best):newGame(),updateBoardView(),$("#score").text(score),$("#best").text(best)}),$(document).keydown(function(e){switch(e.keyCode){case 37:moveLeft();break;case 38:moveUp();break;case 39:moveRight();break;case 40:moveDown()}$("#score").text(score),best<score&&$("#best").text(score),!noSpace()||canMoveUp()||canMoveRight()||canMoveDown()||canMoveLeft()||alert("Game Over!")}),document.addEventListener("touchstart",function(e){startx=e.touches[0].pageX,starty=e.touches[0].pageY}),document.addEventListener("touchend",function(e){endx=e.changedTouches[0].pageX,endy=e.changedTouches[0].pageY;var r=$(".game-container").offset().left,o=$(".game-container").offset().top;e.preventDefault(),r<startx&&startx<r+4*cellSize+5*cellSpace&&o<starty&&starty<o+4*cellSize+5*cellSpace&&(30<Math.abs(endx-startx)||30<Math.abs(endy-starty))&&(Math.abs(endx-startx)>Math.abs(endy-starty)?0<endx-startx?moveRight:moveLeft:0<endy-starty?moveDown:moveUp)()});